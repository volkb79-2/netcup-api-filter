# `.env.workspace` - Workspace Configuration File

## Purpose

The `.env.workspace` file is **auto-generated** by `.devcontainer/post-create.sh` and provides workspace configuration to scripts that run **outside** the post-create.sh context.

## Why Do We Need It?

### Problem
When `post-create.sh` runs, it detects environment characteristics and exports variables to its shell environment. However:

1. **Scripts run in separate processes** (e.g., `start-mcp.sh`, `deploy-test-fix-loop.sh`) don't inherit these variables
2. **New terminal sessions** don't have access to variables from post-create.sh
3. **Docker compose** needs host paths that were detected during devcontainer startup
4. **Manual script invocations** need consistent configuration across all tools

### Solution
Export detected values to `.env.workspace` so any script can load them:

```bash
# In any script:
if [[ -f ".env.workspace" ]]; then
    source .env.workspace
fi

# Now you have access to:
# - PHYSICAL_REPO_ROOT (for Docker volume mounts)
# - SHARED_DOCKER_NETWORK (for container connectivity)
# - ENV_TYPE, USER_UID, DOCKER_GID, etc.
```

## What's Inside?

Generated content example:

```bash
# ============================================================================
# Workspace Environment Configuration (Auto-generated)
# ============================================================================
# Generated by: .devcontainer/post-create.sh
# Purpose: Provides workspace variables to scripts running outside post-create.sh
# 
# Used by:
#   - tooling/playwright/start-mcp.sh (needs SHARED_DOCKER_NETWORK, PHYSICAL_REPO_ROOT)
#   - .vscode/deploy-test-fix-loop.sh (needs all workspace paths)
#   - .vscode/ensure-mcp-connection.sh (needs SHARED_DOCKER_NETWORK)
#   - Any other scripts that need workspace configuration
# 
# Do not edit manually - regenerated on devcontainer rebuild
# ============================================================================
export ENV_TYPE="devcontainer"
export USER_NAME="vscode"
export USER_UID="1003"
export USER_GID="1003"
export DOCKER_GID="994"
export REPO_ROOT="/workspaces/netcup-api-filter"
export PHYSICAL_REPO_ROOT="/home/vb/volkb79-2/netcup-api-filter"
export DOCKER_NETWORK_INTERNAL="naf-dev-network"
```

## Who Uses It?

### 1. `tooling/playwright/start-mcp.sh`
**Needs**: `DOCKER_NETWORK_INTERNAL`, `PHYSICAL_REPO_ROOT`

```bash
# Load workspace environment if available
if [[ -f "$REPO_ROOT/.env.workspace" ]]; then
    source "$REPO_ROOT/.env.workspace"
    echo "✓ Loaded workspace configuration from .env.workspace"
fi

# Use loaded variables
export DOCKER_NETWORK_INTERNAL="${DOCKER_NETWORK_INTERNAL:-naf-dev-network}"
export PHYSICAL_REPO_ROOT="${PHYSICAL_REPO_ROOT:-$REPO_ROOT}"
```

**Why**: Docker compose needs to know which network to use (from global-config.active.toml) and where to mount volumes from the host filesystem.

### 2. `.vscode/deploy-test-fix-loop.sh`
**Needs**: All workspace paths for deployment operations

```bash
if [[ -f ".env.workspace" ]]; then
    source .env.workspace
fi
```

**Why**: Deployment scripts need to know physical host paths for file operations.

### 3. `.vscode/ensure-mcp-connection.sh`
**Needs**: `DOCKER_NETWORK_INTERNAL`

```bash
# Load shared configuration from .env.workspace if available
if [[ -f "/workspaces/netcup-api-filter/.env.workspace" ]]; then
    source "/workspaces/netcup-api-filter/.env.workspace"
fi

# Use network name from TOML config (default: naf-dev-network)
NETWORK="${DOCKER_NETWORK_INTERNAL:-naf-dev-network}"
```

**Why**: Needs to know which network to verify connectivity for (read from global-config.active.toml).

### 4. Future Scripts
Any new script that needs workspace configuration can simply `source .env.workspace`.

## Why Not Just Export to ~/.bashrc?

We do **both** - export to `~/.bashrc` **and** create `.env.workspace`. Here's why:

### `~/.bashrc` (Shell Sessions)
✅ New terminal windows automatically have variables  
✅ Interactive shell use  
❌ Not available to scripts run with `bash script.sh` (non-interactive)  
❌ Not available to scripts run via `docker exec` or other mechanisms  

### `.env.workspace` (Scripts)
✅ Available to any script via explicit `source`  
✅ Works in non-interactive contexts  
✅ Works across all invocation methods  
✅ Single source of truth for workspace config  
❌ Requires explicit sourcing in each script  

## Lifecycle

### Creation
Created by `.devcontainer/post-create.sh` during:
- Initial devcontainer build
- Devcontainer rebuild
- Manual execution of `post-create.sh`

### Usage
Scripts load it at startup:
```bash
[[ -f ".env.workspace" ]] && source .env.workspace
```

### Regeneration
File is **overwritten** each time `post-create.sh` runs. Do not manually edit.

## Key Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `ENV_TYPE` | Environment type | `devcontainer`, `github_actions`, `local` |
| `USER_NAME` | Current user | `vscode` |
| `USER_UID` | User ID | `1003` |
| `USER_GID` | Group ID | `1003` |
| `DOCKER_GID` | Docker group ID | `994` |
| `REPO_ROOT` | Repository root (inside container) | `/workspaces/netcup-api-filter` |
| `PHYSICAL_REPO_ROOT` | Repository root (on host) | `/home/vb/volkb79-2/netcup-api-filter` |
| `DOCKER_NETWORK_INTERNAL` | Docker network name (from TOML config) | `naf-dev-network` |

## Best Practices

### For Script Authors

1. **Always check if file exists** before sourcing:
   ```bash
   if [[ -f ".env.workspace" ]]; then
       source .env.workspace
   fi
   ```

2. **Provide fallback defaults**:
   ```bash
   DOCKER_NETWORK_INTERNAL="${DOCKER_NETWORK_INTERNAL:-naf-dev-network}"
   ```

3. **Document which variables your script needs** in comments:
   ```bash
   # Requires: PHYSICAL_REPO_ROOT, DOCKER_NETWORK_INTERNAL
   source .env.workspace
   ```

### For Users

1. **Don't edit** `.env.workspace` - it will be overwritten
2. **Override variables** via environment if needed:
   ```bash
   DOCKER_NETWORK_INTERNAL=custom-net ./start-mcp.sh
   ```
3. **Rebuild devcontainer** if you need to regenerate with new values

## Troubleshooting

### Script can't find variables

**Problem**: Script reports missing `PHYSICAL_REPO_ROOT` or similar

**Solution**:
```bash
# Check if .env.workspace exists
ls -la /workspaces/netcup-api-filter/.env.workspace

# Regenerate if missing
bash .devcontainer/post-create.sh

# Verify contents
cat .env.workspace
```

### Variables have wrong values

**Problem**: `PHYSICAL_REPO_ROOT` points to wrong location

**Solution**:
```bash
# Override before running script
export PHYSICAL_REPO_ROOT=/correct/path
bash .devcontainer/post-create.sh

# Or set PHYSICAL_REPO_ROOT env var in devcontainer.json
```

### Script still can't access variables

**Problem**: Sourcing `.env.workspace` doesn't work

**Checklist**:
- [ ] Is the script using correct path to `.env.workspace`?
- [ ] Is the script using `source` (not just executing the file)?
- [ ] Are you running the script in the correct directory?
- [ ] Does `.env.workspace` have correct permissions (should be readable)?

## Related Documentation

- `.devcontainer/post-create.sh` - Generation logic
- `SHARED_NETWORK.md` - Network configuration details
- `tooling/playwright/README.md` - Playwright container setup
- `.vscode/README.md` - VS Code MCP configuration
