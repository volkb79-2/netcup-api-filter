# Fail-Fast Configuration Principle

## Philosophy

This project enforces a **strict fail-fast policy** for configuration management: **NO DEFAULTS, NO FALLBACKS**. Variables must be explicitly set at the top/root level, and scripts fail immediately with clear error messages if required configuration is missing.

## Core Principle

**Bad (Fallback Pattern ❌):**
```bash
PORT="${PORT:-8000}"              # Silently uses 8000 if unset
NETWORK="${NETWORK:-mynetwork}"   # Hides configuration issues
DATABASE="${DATABASE:-/tmp/db}"   # May work but not as intended
```

**Good (Fail-Fast Pattern ✅):**
```bash
PORT="${PORT:?PORT must be set (check .env.defaults)}"
NETWORK="${NETWORK:?NETWORK must be set (source .env.workspace)}"
DATABASE="${DATABASE:?DATABASE must be set}"
```

## Why Fail-Fast?

### 1. **Explicit Configuration**
Variables must be intentionally set, preventing "it worked by accident" scenarios.

### 2. **Clear Error Messages**
When something is missing, you get an immediate, actionable error:
```bash
$ ./deploy.sh local
bash: LOCAL_FLASK_PORT: LOCAL_FLASK_PORT not set - check .env.defaults
```

### 3. **No Silent Failures**
Fallback defaults can mask configuration issues until production:
- ❌ `PORT="${PORT:-8000}"` → Silently uses wrong port
- ✅ `PORT="${PORT:?PORT not set}"` → Fails immediately with clear message

### 4. **Single Source of Truth**
Configuration has a clear hierarchy with no hidden defaults:
1. `.env.defaults` - Project-wide defaults (version-controlled)
2. `.env.workspace` - Environment-specific (auto-generated)
3. `.env.services` - Service naming (centralized)
4. `.env` files in tooling/ - Service-specific config

## Implementation Guide

### Shell Scripts

#### Required Variables

```bash
#!/bin/bash
set -euo pipefail

# Source configuration first
source "${REPO_ROOT:?REPO_ROOT not set}/.env.workspace"

# Then validate all required variables
DOCKER_NETWORK="${DOCKER_NETWORK_INTERNAL:?DOCKER_NETWORK_INTERNAL not set (source .env.workspace)}"
FLASK_PORT="${LOCAL_FLASK_PORT:?LOCAL_FLASK_PORT not set (check .env.defaults)}"
PUBLIC_FQDN="${PUBLIC_FQDN:?PUBLIC_FQDN not set (source .env.workspace or rebuild devcontainer)}"
```

#### Error Message Format

Error messages should provide:
1. **What** is missing
2. **Where** to set it
3. **How** to fix it (optional)

```bash
# Good error messages
"${VARIABLE:?VARIABLE not set (source .env.workspace)}"
"${PORT:?PORT not set (check .env.defaults)}"
"${TOKEN:?TOKEN not set (run: generate-token.sh)}"
"${DB_PATH:?DB_PATH must be set}"

# Bad error messages
"${VARIABLE:?missing}"                    # Not helpful
"${VARIABLE:?VARIABLE not set}"           # No hint
"${VARIABLE:?provide VARIABLE}"           # Unclear
```

### Docker Compose Files

Docker Compose also supports fail-fast with `${VAR:?error}`:

```yaml
services:
  app:
    image: myapp:latest
    environment:
      - DOCKER_UID=${DOCKER_UID:?DOCKER_UID must be set}
      - DOCKER_GID=${DOCKER_GID:?DOCKER_GID must be set}
    volumes:
      - ${PHYSICAL_REPO_ROOT:?PHYSICAL_REPO_ROOT must be set}:/workspace
    networks:
      - ${DOCKER_NETWORK_INTERNAL:?DOCKER_NETWORK_INTERNAL must be set}

networks:
  default:
    name: ${DOCKER_NETWORK_INTERNAL:?DOCKER_NETWORK_INTERNAL must be set}
    external: true
```

### Python Configuration

```python
import os

# Fail-fast for required environment variables
def get_required_env(name: str, hint: str = "") -> str:
    """Get required environment variable or raise clear error."""
    value = os.environ.get(name)
    if not value:
        hint_msg = f" ({hint})" if hint else ""
        raise EnvironmentError(f"{name} not set{hint_msg}")
    return value

# Usage
DATABASE_PATH = get_required_env("DATABASE_PATH", "check .env.defaults")
API_KEY = get_required_env("API_KEY", "set in .env or environment")
```

## Configuration Hierarchy

### Level 1: Project Defaults (`.env.defaults`)

Version-controlled defaults for all environments:

```bash
# .env.defaults
export LOCAL_FLASK_PORT="5100"
export WEBHOSTING_URL="https://naf.vxxu.de"
export NETCUP_SSH_USER="hosting218629"
export NETCUP_SSH_HOST="hosting218629.ae98d.netcup.net"
```

**Scripts must source this first:**
```bash
source "${REPO_ROOT}/.env.defaults"
```

### Level 2: Workspace Environment (`.env.workspace`)

Auto-generated, environment-specific values:

```bash
# .env.workspace (generated by post-create.sh)
export REPO_ROOT="/workspaces/netcup-api-filter"
export PHYSICAL_REPO_ROOT="/home/vb/volkb79-2/netcup-api-filter"
export DOCKER_NETWORK_INTERNAL="naf-dev-network"
export PUBLIC_FQDN="gstammtisch.dchive.de"
```

**Scripts should source this after .env.defaults:**
```bash
source "${REPO_ROOT}/.env.workspace"
```

### Level 3: Service Names (`.env.services`)

Centralized service/container naming:

```bash
# .env.services
export SERVICE_PLAYWRIGHT="naf-dev-playwright"
export SERVICE_REVERSE_PROXY="naf-dev-reverse-proxy"
export MAILPIT_API_URL="http://naf-dev-mailpit:8025/api/v1"
```

### Level 4: Service-Specific Config

Each service has its own `.env` in `tooling/{service}/`:

```bash
# tooling/reverse-proxy/.env
LOCAL_TLS_DOMAIN=${PUBLIC_FQDN}  # References workspace variable
LOCAL_APP_PORT=5100
LOCAL_TLS_BIND_HTTPS=443
```

## Migration Checklist

When converting existing code to fail-fast:

- [ ] Identify all `${VAR:-default}` patterns
- [ ] Determine where variable SHOULD be set (which config file)
- [ ] Replace with `${VAR:?VAR not set (hint where to set it)}`
- [ ] Test that script fails gracefully with clear error
- [ ] Update top-level config file with required variable
- [ ] Verify fix: script should now work after sourcing config
- [ ] Document the configuration requirement

## Example Conversion

### Before (Fallback Pattern)

```bash
#!/bin/bash
set -euo pipefail

# Fallbacks hide configuration issues
FLASK_PORT="${FLASK_PORT:-5100}"
DB_PATH="${DB_PATH:-/tmp/default.db}"
NETWORK="${NETWORK:-mynetwork}"

# Script continues with potentially wrong values
flask run --port "$FLASK_PORT"
```

**Problems:**
- May use wrong port without noticing
- Database might end up in /tmp instead of proper location
- Network name might not match other services

### After (Fail-Fast Pattern)

```bash
#!/bin/bash
set -euo pipefail

# Load configuration hierarchy
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export REPO_ROOT="${REPO_ROOT:?REPO_ROOT not set}"

# Source configuration files
source "${REPO_ROOT}/.env.defaults"
source "${REPO_ROOT}/.env.workspace"

# Validate all required variables
FLASK_PORT="${LOCAL_FLASK_PORT:?LOCAL_FLASK_PORT not set (check .env.defaults)}"
DB_PATH="${DATABASE_PATH:?DATABASE_PATH not set (check .env.defaults)}"
NETWORK="${DOCKER_NETWORK_INTERNAL:?DOCKER_NETWORK_INTERNAL not set (source .env.workspace)}"

# Now safe to use - guaranteed to be set correctly
flask run --port "$FLASK_PORT"
```

## Testing Fail-Fast Behavior

### Positive Test (Should Succeed)

```bash
# Ensure all config is loaded
source .env.defaults
source .env.workspace
source .env.services

# Script should work
./deploy.sh local --skip-tests
```

### Negative Test (Should Fail with Clear Error)

```bash
# Unset a required variable
unset LOCAL_FLASK_PORT

# Script should fail immediately with helpful error
./deploy.sh local
# Expected: bash: LOCAL_FLASK_PORT: LOCAL_FLASK_PORT not set - check .env.defaults
```

## Common Patterns

### Pattern 1: Script Startup

```bash
#!/bin/bash
set -euo pipefail

# Establish workspace root (only acceptable fallback)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export REPO_ROOT="${SCRIPT_DIR}"

# Load configuration hierarchy (fail if missing)
if [[ -f "${REPO_ROOT}/.env.defaults" ]]; then
    source "${REPO_ROOT}/.env.defaults"
else
    echo "ERROR: .env.defaults not found" >&2
    exit 1
fi

if [[ -f "${REPO_ROOT}/.env.workspace" ]]; then
    source "${REPO_ROOT}/.env.workspace"
else
    echo "ERROR: .env.workspace not found (run post-create.sh)" >&2
    exit 1
fi

# Now validate required variables
REQUIRED_VAR="${REQUIRED_VAR:?REQUIRED_VAR not set (check .env.defaults)}"
```

### Pattern 2: Docker Compose Service

```yaml
version: '3.8'

services:
  app:
    image: myapp:latest
    container_name: ${SERVICE_NAME:?SERVICE_NAME must be set (source .env.services)}
    environment:
      - DATABASE_PATH=${DATABASE_PATH:?DATABASE_PATH must be set}
      - API_KEY=${API_KEY:?API_KEY must be set}
    volumes:
      - ${PHYSICAL_REPO_ROOT:?PHYSICAL_REPO_ROOT must be set}:/workspace
    networks:
      - app-network

networks:
  app-network:
    name: ${DOCKER_NETWORK_INTERNAL:?DOCKER_NETWORK_INTERNAL must be set (source .env.workspace)}
    external: true
```

### Pattern 3: Function Arguments

```bash
deploy_to_target() {
    local target="${1:?target required (local|webhosting)}"
    local mode="${2:?mode required (mock|live)}"
    
    # Function fails immediately if arguments missing
    echo "Deploying to $target in $mode mode"
}

# Usage
deploy_to_target "$DEPLOYMENT_TARGET" "$DEPLOYMENT_MODE"
```

## Exceptions (Rare)

The ONLY acceptable use of fallback `:-` syntax:

### 1. User-Facing Optional Flags

```bash
# Optional features that default to off
SKIP_TESTS="${SKIP_TESTS:-false}"
VERBOSE="${VERBOSE:-false}"
DRY_RUN="${DRY_RUN:-false}"
```

### 2. Backward Compatibility (Temporary)

```bash
# Legacy support (document removal timeline)
# TODO: Remove by 2025-12-31
OLD_VAR="${NEW_VAR:-${OLD_VAR}}"
```

### 3. Progressive Enhancement

```bash
# Feature available but not required
ENABLE_FEATURE_X="${ENABLE_FEATURE_X:-false}"
```

## Benefits Summary

1. **Configuration errors caught early** - At script start, not deep in execution
2. **Clear error messages** - Know exactly what's missing and where to fix it
3. **No silent failures** - Wrong configuration = immediate failure
4. **Explicit dependencies** - Variables must be intentionally set
5. **Easier debugging** - No hunting for where defaults come from
6. **Safer deployments** - Production won't silently use development defaults
7. **Better documentation** - Error messages document configuration requirements

## See Also

- [Configuration Guide](CONFIGURATION_GUIDE.md) - Complete configuration system
- [Environment Files](ENV_WORKSPACE.md) - `.env.workspace` documentation  
- [Deployment Workflow](DEPLOYMENT_WORKFLOW.md) - How config flows through deployment
- [Service Naming](.env.services) - Centralized service name registry
