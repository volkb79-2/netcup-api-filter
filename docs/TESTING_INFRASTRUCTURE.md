# Testing Infrastructure Improvements

## Overview

This document describes the automated testing infrastructure improvements made to ease local development and testing workflows.

## New Scripts

### 1. Flask Manager (`tooling/flask-manager.sh`)

Centralized Flask process management for local testing.

**Commands:**
```bash
# Start Flask backend
./tooling/flask-manager.sh start

# Stop Flask backend
./tooling/flask-manager.sh stop

# Restart Flask backend
./tooling/flask-manager.sh restart

# Check Flask status
./tooling/flask-manager.sh status

# Tail Flask logs
./tooling/flask-manager.sh logs
```

**Features:**
- PID file management (no more orphaned processes)
- Automatic health check (waits for Flask to be ready)
- Fail-fast validation (checks deploy directory and database exist)
- Clear error messages with suggestions
- Logs centralized in `tmp/flask.log`

**Configuration:**
- Uses `.env.workspace` for environment detection
- Default deploy dir: `deploy/`
- Default port: `5100`
- Override with: `--deploy-dir DIR` or `--port PORT`

### 2. Reset Local Deployment (`tooling/reset-local-deployment.sh`)

Quick reset to fresh state with default credentials.

**Usage:**
```bash
# Full reset: rebuild deployment and restart Flask
./tooling/reset-local-deployment.sh

# Keep deployment files, only reset database
./tooling/reset-local-deployment.sh --skip-rebuild

# Reset with demo data seeded
./tooling/reset-local-deployment.sh --seed-demo

# Reset but don't restart Flask
./tooling/reset-local-deployment.sh --no-restart
```

**Use Cases:**
- Quick iteration during development
- Reset after failed tests
- Test fresh installation workflow
- Recover from broken state

### 3. Installation Workflow Test (`ui_tests/tests/test_installation_workflow.py`)

Automated E2E test for fresh installation workflow.

**Test Coverage:**
1. Login with default credentials (admin/admin)
2. Forced password change on first login
3. Email setup during initial configuration
4. SMTP verification (pre-seeded config)
5. Automatic 2FA enablement when email is configured
6. Logout and re-login with new password
7. 2FA email verification via Mailpit API
8. Successful dashboard access

**Running:**
```bash
# Run installation workflow test only
pytest ui_tests/tests/test_installation_workflow.py -v

# Run with other tests
./run-local-tests.sh
```

**Prerequisites:**
- Fresh deployment with default credentials
- Mailpit running (`tooling/mailpit/docker compose up -d`)
- SMTP config pre-seeded in database

## Integrated Workflow

### Before (Manual)

```bash
# Manual steps (error-prone)
pkill -9 -f flask
cd /workspaces/netcup-api-filter
rm -rf deploy
python3 build_deployment.py --target local
cd deploy
DATABASE_PATH=$PWD/netcup_filter.db nohup python3 -m flask --app passenger_wsgi:application run --host=0.0.0.0 --port=5100 >/tmp/local_app.log 2>&1 &
sleep 5
# Hope Flask started...
# Run tests manually
# Kill Flask manually (hopefully all processes)
pkill -9 -f flask
```

### After (Automated)

```bash
# Single command for complete test run
./run-local-tests.sh

# Or for quick iteration:
./tooling/reset-local-deployment.sh    # Reset to fresh state
pytest ui_tests/tests/test_installation_workflow.py -v  # Run specific test
./tooling/flask-manager.sh logs        # Debug if needed
```

## Benefits

### 1. **No More Orphaned Processes**
- PID file management prevents multiple Flask instances
- Clean shutdown with `flask-manager.sh stop`
- Automatic cleanup in test scripts

### 2. **Faster Iteration**
- `reset-local-deployment.sh` rebuilds in ~10 seconds
- No need to manually check if Flask is running
- No need to manually kill processes

### 3. **Reliable Testing**
- Health checks ensure Flask is ready before tests run
- Automatic retry logic for transient failures
- Clear error messages when things go wrong

### 4. **Better Observability**
- Centralized logs in `tmp/flask.log`
- Status command shows PID and port
- Logs command for real-time debugging

### 5. **Integration with Existing Tools**
- `run-local-tests.sh` now uses Flask manager
- Consistent behavior across all test scripts
- Works with Playwright container

## Configuration

### Environment Variables

Flask manager and reset script use `.env.workspace` for configuration:

```bash
# Set in .env.workspace (auto-generated by post-create.sh)
REPO_ROOT=/workspaces/netcup-api-filter
DOCKER_NETWORK_INTERNAL=naf-dev-network
PUBLIC_FQDN=gstammtisch.dchive.de
```

### Database Path

Automatically detected based on deploy directory:
- `deploy/netcup_filter.db` for standard local testing
- Configurable via `DATABASE_PATH` environment variable

## Testing Workflow

### 1. Fresh Installation Test

```bash
# Reset to fresh state
./tooling/reset-local-deployment.sh

# Run installation workflow test
pytest ui_tests/tests/test_installation_workflow.py -v -s
```

### 2. Full Test Suite

```bash
# Runs all tests including installation workflow
./run-local-tests.sh
```

### 3. Debugging

```bash
# Check Flask status
./tooling/flask-manager.sh status

# View logs in real-time
./tooling/flask-manager.sh logs

# Restart Flask
./tooling/flask-manager.sh restart
```

## Future Improvements

### 1. Database-Only Reset

Currently `--skip-rebuild` doesn't fully work because we don't have a standalone database init script. 

**TODO:** Create `tooling/init-database.sh` to:
- Initialize empty database schema
- Seed default admin account
- Seed backend providers
- Optionally seed demo data

### 2. Test Markers

Add pytest markers for different test categories:

```python
@pytest.mark.installation  # Fresh installation tests
@pytest.mark.upgrade       # Upgrade/migration tests
@pytest.mark.integration   # Integration tests with real services
@pytest.mark.unit          # Unit tests
```

### 3. Parallel Testing

Flask manager could support multiple instances:

```bash
# Start Flask on different ports for parallel tests
./tooling/flask-manager.sh start --port 5100 --pid flask1.pid
./tooling/flask-manager.sh start --port 5101 --pid flask2.pid
```

### 4. Container-based Testing

Move Flask into its own container for better isolation:

```bash
# Flask in container, tests in Playwright container
docker compose -f tooling/testing/docker-compose.yml up -d
pytest ui_tests/tests -v
```

## Troubleshooting

### Flask Won't Start

```bash
# Check logs
./tooling/flask-manager.sh logs

# Check if port is in use
netstat -tuln | grep 5100

# Check deploy directory exists
ls -la deploy/

# Check database exists
ls -la deploy/netcup_filter.db
```

### Tests Fail with "Connection Refused"

```bash
# Verify Flask is running
./tooling/flask-manager.sh status

# Check Flask is listening on correct port
curl -s http://localhost:5100/admin/login | head -5

# Check reverse proxy if using HTTPS
docker ps | grep reverse-proxy
```

### Stale Database State

```bash
# Reset to fresh state
./tooling/reset-local-deployment.sh

# Or rebuild from scratch
rm -rf deploy/ && python3 build_deployment.py --target local
```

## Related Documentation

- `LOCAL_TESTING_GUIDE.md` - Comprehensive local testing guide
- `TESTING_STRATEGY.md` - Overall testing strategy
- `PLAYWRIGHT_CONTAINER.md` - Playwright container setup
- `MAILPIT_CONFIGURATION.md` - Mailpit SMTP testing setup
