# Environment Defaults System

> **Status:** Archived reference. The living documentation for defaults and overrides is `CONFIGURATION_GUIDE.md`.

## Overview

This project uses `.env.defaults` as the **single source of truth** for default credentials and configuration. This eliminates hardcoded values scattered across code, scripts, and documentation.

## File Structure

### `.env.defaults` (tracked in git)
**Purpose**: Single source of truth for default values used in fresh deployments.

**Location**: Project root (`/workspaces/netcup-api-filter/.env.defaults`)

**Contents**:
```env
# Default admin credentials (used for fresh database seeding)
DEFAULT_ADMIN_USERNAME=admin
DEFAULT_ADMIN_PASSWORD=admin

# Default test client credentials (preseeded in database)
DEFAULT_TEST_CLIENT_ID=test_qweqweqwe_vi
DEFAULT_TEST_CLIENT_TOKEN=qweqweqwe-vi-readonly
DEFAULT_TEST_CLIENT_DESCRIPTION=Sample read-only client for qweqweqwe.vi
DEFAULT_TEST_CLIENT_REALM_TYPE=host
DEFAULT_TEST_CLIENT_REALM_VALUE=qweqweqwe.vi
DEFAULT_TEST_CLIENT_RECORD_TYPES=A
DEFAULT_TEST_CLIENT_OPERATIONS=read
```

**Git Tracking**: ✅ **Tracked** - This file is committed to git as it contains non-secret defaults.

### `.env.webhosting` (NOT tracked in git)
**Purpose**: Represents the **live deployment state** after deployment. Updated by tests when passwords change.

**Location**: 
- In deployment package: `/netcup-api-filter/.env.webhosting`
- In Playwright container: `/screenshots/.env.webhosting` (writable mount)

**Contents** (example):
```env
# Deployment state - updated by tests when passwords change
DEPLOYED_ADMIN_USERNAME=admin
DEPLOYED_ADMIN_PASSWORD=TestAdmin123!
DEPLOYED_AT=2025-11-23T21:49:50Z
```

**Git Tracking**: ❌ **NOT tracked** - This file contains live credentials and changes after deployment.

**Creation**: Auto-generated by `build_deployment.py` during build process, initialized from `.env.defaults`.

## How It Works

### Build Process (`build_deployment.py`)

1. **Reads** `.env.defaults` to get default credentials
2. **Seeds** database with default admin user and test client
3. **Creates** `.env.webhosting` with initial deployment state:
   ```python
   DEPLOYED_ADMIN_USERNAME=admin  # from .env.defaults
   DEPLOYED_ADMIN_PASSWORD=admin  # from .env.defaults
   DEPLOYED_AT=2025-11-23T21:49:50Z
   ```
4. **Packages** everything into `deploy.zip`

### Deployment (`build-and-deploy.sh`)

1. **Builds** package (includes fresh `.env.webhosting`)
2. **Uploads** `deploy.zip` to server
3. **Extracts** all files including `.env.webhosting`
4. **Restarts** Passenger

**Result**: Fresh deployment with default credentials from `.env.defaults`.

### Test Runs (`ui_tests/`)

1. **First test run after deployment**:
   - Tests read `DEPLOYED_ADMIN_PASSWORD=admin` from `.env.webhosting`
   - Tests login with `admin` / `admin`
   - Tests change password to `TestAdmin123!`
   - Tests **update** `.env.webhosting`: `DEPLOYED_ADMIN_PASSWORD=TestAdmin123!`

2. **Subsequent test runs**:
   - Tests read `DEPLOYED_ADMIN_PASSWORD=TestAdmin123!` from `.env.webhosting`
   - Tests use the **new** password automatically
   - No database reset needed

### Configuration Priority (`ui_tests/config.py`)

The test configuration loads values in this priority order:

1. **Environment variables** (highest priority)
2. **`.env.webhosting`** (updated by tests)
3. **`.env.defaults`** (fallback, mapped to `DEPLOYED_*` variables)

Example:
```python
# If DEPLOYED_ADMIN_PASSWORD is not in environment:
# 1. Check .env.webhosting for DEPLOYED_ADMIN_PASSWORD
# 2. Check .env.defaults for DEFAULT_ADMIN_PASSWORD
# 3. Fall back to hardcoded "admin"
```

## Benefits

### ✅ Single Source of Truth
- Default credentials defined **once** in `.env.defaults`
- No hardcoded `"admin"` / `"admin"` scattered in code
- Documentation references `.env.defaults` instead of hardcoding values

### ✅ Test Persistence
- Password changes persist to `.env.webhosting`
- Tests work across multiple runs without database resets
- Clear separation between defaults and live state

### ✅ Clear Workflow
```
.env.defaults (defaults) → build → .env.webhosting (live state) → tests update → tests use updated values
```

### ✅ Easy Customization
To change default credentials:
1. Edit `.env.defaults`
2. Rebuild deployment package
3. Deploy - fresh database uses new defaults

## File Locations

### In Repository
```
/workspaces/netcup-api-filter/
├── .env.defaults              # Tracked, default values
├── .env.webhosting            # NOT tracked, live state (created after build)
└── deploy/
    ├── .env.defaults          # Copied during build
    └── .env.webhosting        # Created during build
```

### After Deployment (Server)
```
/netcup-api-filter/
├── .env.defaults              # Deployed, reference only
└── .env.webhosting            # Deployed, updated by tests
```

### In Playwright Container
```
/workspace/
└── .env.defaults              # Read-only mount from repo

/screenshots/
└── .env.webhosting            # Writable mount, persisted across runs
```

## Code Integration

### Bootstrap Seeding (`bootstrap/seeding.py`)

```python
# Loads .env.defaults automatically
_ENV_DEFAULTS = _load_env_defaults()

@dataclass
class AdminSeedOptions:
    username: str = None
    password: str = None
    
    def __post_init__(self):
        # Falls back to .env.defaults
        if self.username is None:
            self.username = _ENV_DEFAULTS.get("DEFAULT_ADMIN_USERNAME", "admin")
        if self.password is None:
            self.password = _ENV_DEFAULTS.get("DEFAULT_ADMIN_PASSWORD", "admin")
```

### Build Process (`build_deployment.py`)

```python
def create_initial_env_webhosting(deploy_dir):
    # Load defaults from .env.defaults
    defaults = load_from_env_defaults()
    
    # Create .env.webhosting with initial state
    with open(env_webhosting_path, 'w') as f:
        f.write(f"DEPLOYED_ADMIN_USERNAME={defaults['DEFAULT_ADMIN_USERNAME']}\n")
        f.write(f"DEPLOYED_ADMIN_PASSWORD={defaults['DEFAULT_ADMIN_PASSWORD']}\n")
        f.write(f"DEPLOYED_AT={timestamp}\n")
```

### Test Workflows (`ui_tests/workflows.py`)

```python
def _update_deployment_state(**kwargs):
    # Updates .env.webhosting after password changes
    with open('/screenshots/.env.webhosting', 'w') as f:
        f.write(f"DEPLOYED_ADMIN_PASSWORD={new_password}\n")
```

### Test Configuration (`ui_tests/config.py`)

```python
def _load_deployment_state(self):
    # Priority: env vars > .env.webhosting > .env.defaults
    load_env_file('.env.defaults', prefix="DEFAULT_")  # Maps to DEPLOYED_*
    load_env_file('.env.webhosting')                    # Direct DEPLOYED_*
```

## Migration from Hardcoded Values

**Before**:
```python
# Scattered hardcoded values
AdminSeedOptions(username="admin", password="admin")
seed_default_entities(AdminSeedOptions(username="admin", password="admin"))
# Documentation: "Login with admin/admin"
```

**After**:
```python
# Single source of truth
AdminSeedOptions()  # Loads from .env.defaults automatically
seed_default_entities()  # Uses defaults from .env.defaults
# Documentation: "Login with credentials from .env.defaults"
```

## Security Notes

1. **`.env.defaults` is tracked in git** because it contains **non-secret** default values used for initial seeding. These are meant to be changed on first login.

2. **`.env.webhosting` is NOT tracked** because it contains **live credentials** after password changes.

3. **Never commit `.env.webhosting`** - It's in `.gitignore` to prevent accidental commits.

4. **Production deployments** should change default passwords immediately after first login.

## Troubleshooting

### Problem: Tests fail with "invalid credentials"

**Solution**: Check if `.env.webhosting` exists and has correct password:
```bash
cat /screenshots/.env.webhosting
# Should show DEPLOYED_ADMIN_PASSWORD=TestAdmin123! after first test run
```

### Problem: Database has wrong credentials after deployment

**Solution**: Check `.env.defaults` was copied to deployment package:
```bash
ls -la deploy/.env.defaults
cat deploy/.env.defaults
```

### Problem: Tests use wrong password

**Solution**: Delete `.env.webhosting` to reset to defaults:
```bash
rm /screenshots/.env.webhosting
# Next test run will use defaults from .env.defaults
```

## Summary

- **`.env.defaults`**: Single source of truth for default values (tracked)
- **`.env.webhosting`**: Live deployment state (NOT tracked, updated by tests)
- **Priority**: Environment > `.env.webhosting` > `.env.defaults`
- **Workflow**: Defaults → Build → Deploy → Tests update → Tests use updated values
- **Benefit**: No hardcoded credentials, clear separation of defaults and live state
