{# Account Change Password Page #}
{% extends "account/base.html" %}

{% block title %}Change Password - Account Portal - Netcup API Filter{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-2">
            <li class="breadcrumb-item"><a href="{{ url_for('account.settings') }}">Settings</a></li>
            <li class="breadcrumb-item active">Change Password</li>
        </ol>
    </nav>
    <h1 class="h3 mb-1">
        <i class="bi bi-key-fill me-2"></i>Change Password
    </h1>
</div>

<div class="row justify-content-center">
    <div class="col-lg-6 col-xl-5">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-shield-lock me-1"></i>Update Your Password
            </div>
            <div class="card-body">
                <form method="POST" id="changePasswordForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <!-- Current Password Section -->
                    <div class="mb-4 pb-3 border-bottom">
                        <h6 class="text-muted mb-3">Current Credentials</h6>
                        
                        <div class="mb-3">
                            <label for="current_password" class="form-label">Current Password <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="password" class="form-control font-monospace" id="current_password" 
                                       name="current_password" required autocomplete="current-password">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('current_password', this)">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- New Password Section -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">New Credentials</h6>
                        
                        <div class="mb-3">
                            <label for="new_password" class="form-label">
                                New Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control font-monospace" id="new_password" 
                                       name="new_password" required autocomplete="new-password"
                                       oninput="checkPasswordStrength()">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('new_password', this)">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-primary" type="button" onclick="generatePassword()">
                                    <i class="bi bi-magic me-1"></i>Generate
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="confirm_password" class="form-label">
                                Confirm Password <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control font-monospace" id="confirm_password" 
                                       name="confirm_password" required autocomplete="new-password"
                                       oninput="checkPasswordMatch()">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirm_password', this)">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <div id="passwordMismatch" class="text-danger small mt-1" style="display: none;">
                                <i class="bi bi-exclamation-circle me-1"></i>Passwords do not match
                            </div>
                        </div>
                        
                        <!-- Password Strength Indicator -->
                        <div class="card bg-body-secondary mb-3">
                            <div class="card-body py-2">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="small text-muted me-2">Strength:</span>
                                    <div class="progress flex-grow-1" style="height: 8px;">
                                        <div class="progress-bar" id="strengthBar" role="progressbar" 
                                             style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <span class="badge ms-2" id="strengthBadge">-</span>
                                </div>
                                <div class="small" id="strengthChecks">
                                    <span class="text-muted me-2" id="checkUpper">
                                        <i class="bi bi-x-circle"></i> Uppercase
                                    </span>
                                    <span class="text-muted me-2" id="checkLower">
                                        <i class="bi bi-x-circle"></i> Lowercase
                                    </span>
                                    <span class="text-muted me-2" id="checkNumber">
                                        <i class="bi bi-x-circle"></i> Numbers
                                    </span>
                                    <span class="text-muted" id="checkSymbol">
                                        <i class="bi bi-x-circle"></i> Symbols
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('account.settings') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left me-1"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                            <i class="bi bi-check-circle me-1"></i>Change Password
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Safe printable ASCII - excludes: ! (shell history), ` (command substitution), ' " (quoting)
const PASSWORD_CHARSET = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-=_+;:,.|/?@#$%^&*';

function togglePassword(inputId, btn) {
    const input = document.getElementById(inputId);
    const icon = btn.querySelector('i');
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'bi bi-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'bi bi-eye';
    }
}

function generatePassword() {
    const length = 24;
    let password = '';
    const array = new Uint8Array(length);
    crypto.getRandomValues(array);
    for (let i = 0; i < length; i++) {
        password += PASSWORD_CHARSET[array[i] % PASSWORD_CHARSET.length];
    }
    document.getElementById('new_password').value = password;
    document.getElementById('confirm_password').value = password;
    checkPasswordStrength();
    checkPasswordMatch();
}

function calculateEntropy(password) {
    if (!password) return 0;
    let charset = 0;
    if (/[a-z]/.test(password)) charset += 26;
    if (/[A-Z]/.test(password)) charset += 26;
    if (/[0-9]/.test(password)) charset += 10;
    if (/[^a-zA-Z0-9]/.test(password)) charset += 32;
    return password.length * Math.log2(charset || 1);
}

function checkPasswordStrength() {
    const password = document.getElementById('new_password').value;
    const strengthBar = document.getElementById('strengthBar');
    const strengthBadge = document.getElementById('strengthBadge');
    
    // Character checks
    const hasUpper = /[A-Z]/.test(password);
    const hasLower = /[a-z]/.test(password);
    const hasNumber = /[0-9]/.test(password);
    const hasSymbol = /[^a-zA-Z0-9]/.test(password);
    
    updateCheck('checkUpper', hasUpper);
    updateCheck('checkLower', hasLower);
    updateCheck('checkNumber', hasNumber);
    updateCheck('checkSymbol', hasSymbol);
    
    // Calculate entropy
    const entropy = calculateEntropy(password);
    const percentage = Math.min(100, (entropy / 128) * 100);
    
    strengthBar.style.width = percentage + '%';
    
    if (entropy < 40) {
        strengthBar.className = 'progress-bar bg-danger';
        strengthBadge.className = 'badge bg-danger';
        strengthBadge.textContent = 'Weak';
    } else if (entropy < 60) {
        strengthBar.className = 'progress-bar bg-warning';
        strengthBadge.className = 'badge bg-warning';
        strengthBadge.textContent = 'Fair';
    } else if (entropy < 80) {
        strengthBar.className = 'progress-bar bg-info';
        strengthBadge.className = 'badge bg-info';
        strengthBadge.textContent = 'Good';
    } else {
        strengthBar.className = 'progress-bar bg-success';
        strengthBadge.className = 'badge bg-success';
        strengthBadge.textContent = `Strong (${Math.round(entropy)} bits)`;
    }
    
    validateForm();
}

function updateCheck(id, passed) {
    const el = document.getElementById(id);
    if (passed) {
        el.className = 'text-success me-2';
        el.querySelector('i').className = 'bi bi-check-circle-fill';
    } else {
        el.className = 'text-muted me-2';
        el.querySelector('i').className = 'bi bi-x-circle';
    }
}

function checkPasswordMatch() {
    const password = document.getElementById('new_password').value;
    const confirm = document.getElementById('confirm_password').value;
    const mismatchEl = document.getElementById('passwordMismatch');
    
    if (confirm && password !== confirm) {
        mismatchEl.style.display = 'block';
    } else {
        mismatchEl.style.display = 'none';
    }
    
    validateForm();
}

function validateForm() {
    const current = document.getElementById('current_password').value;
    const password = document.getElementById('new_password').value;
    const confirm = document.getElementById('confirm_password').value;
    const entropy = calculateEntropy(password);
    
    const valid = current.length > 0 && 
                  password.length >= 12 && 
                  password === confirm && 
                  entropy >= 40;
    
    document.getElementById('submitBtn').disabled = !valid;
}

// Validate on any input
document.getElementById('current_password').addEventListener('input', validateForm);
</script>
{% endblock %}
