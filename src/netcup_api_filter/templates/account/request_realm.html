{# Request Realm Page - Updated for Multi-Backend Architecture #}
{% extends "account/base.html" %}

{% block title %}Request New Realm{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Header -->
            <div class="d-flex align-items-center mb-4">
                <a href="{{ url_for('account.realms') }}" class="btn btn-outline-secondary btn-sm me-3">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <div>
                    <h2 class="mb-0">Request New Realm</h2>
                    <small class="text-muted">Request access to manage DNS records</small>
                </div>
            </div>

            {% if not available_roots %}
            <!-- No Available Roots Alert -->
            <div class="alert alert-warning">
                <h5 class="alert-heading">
                    <i class="bi bi-exclamation-triangle me-2"></i>No DNS Zones Available
                </h5>
                <p class="mb-0">
                    There are currently no DNS zones available for you to request realms under.
                    Please contact an administrator to get access to a DNS zone.
                </p>
            </div>
            {% else %}

            <!-- Use Case Templates -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-lightning me-2"></i>Quick Templates
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <button type="button" class="btn btn-outline-primary w-100 h-100 py-3 template-btn"
                                    data-realm-type="host"
                                    data-record-types="A,AAAA"
                                    data-operations="read,update">
                                <i class="bi bi-house d-block fs-3 mb-2"></i>
                                <strong>DDNS Single Host</strong>
                                <small class="d-block text-muted mt-1">Update single hostname IP</small>
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-outline-warning w-100 h-100 py-3 template-btn"
                                    data-realm-type="subdomain"
                                    data-record-types="TXT"
                                    data-operations="read,create,delete">
                                <i class="bi bi-shield-lock d-block fs-3 mb-2"></i>
                                <strong>Let's Encrypt DNS-01</strong>
                                <small class="d-block text-muted mt-1">Automated certificates</small>
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-outline-success w-100 h-100 py-3 template-btn"
                                    data-realm-type="subdomain"
                                    data-record-types="A,AAAA,CNAME,TXT,MX"
                                    data-operations="read,create,update,delete">
                                <i class="bi bi-gear d-block fs-3 mb-2"></i>
                                <strong>Full Management</strong>
                                <small class="d-block text-muted mt-1">Complete control</small>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Request Form -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-pencil me-2"></i>Realm Details
                    </h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('account.request_realm') }}" method="post" id="request-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <!-- DNS Zone Selection (Dropdown) -->
                        <div class="mb-4">
                            <label for="domain_root_id" class="form-label">DNS Zone <span class="text-danger">*</span></label>
                            <select class="form-select" id="domain_root_id" name="domain_root_id" required>
                                <option value="">Select available zone...</option>
                                {% for root in available_roots %}
                                <option value="{{ root.id }}" data-root-domain="{{ root.root_domain }}">
                                    {{ root.display_name or root.root_domain }}
                                    {% if root.backend_service %}({{ root.backend_service.provider.display_name }}){% endif %}
                                    {% if root.is_public() %} [Public]{% endif %}
                                </option>
                                {% endfor %}
                                {% if user_backends %}
                                <option disabled>──────────────</option>
                                <option value="user_backend">Use my own backend credentials</option>
                                {% endif %}
                            </select>
                            <div class="form-text">
                                Select the DNS zone you want to manage records under
                            </div>
                        </div>

                        <!-- Subdomain Input -->
                        <div class="mb-4">
                            <label for="subdomain" class="form-label">Subdomain</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="subdomain" name="subdomain"
                                       pattern="[a-z0-9\-]*"
                                       placeholder="myhost">
                                <span class="input-group-text" id="domain-suffix">.example.com</span>
                            </div>
                            <div class="form-text">
                                Your full hostname will be: <code id="full-hostname-preview">myhost.example.com</code>
                            </div>
                        </div>

                        <!-- Realm Type -->
                        <div class="mb-4">
                            <label class="form-label">Realm Type</label>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="form-check card p-3">
                                        <input class="form-check-input" type="radio" name="realm_type" 
                                               id="type-host" value="host" checked>
                                        <label class="form-check-label d-block" for="type-host">
                                            <strong>Exact Host</strong>
                                            <small class="d-block text-muted">Only this hostname</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check card p-3">
                                        <input class="form-check-input" type="radio" name="realm_type" 
                                               id="type-subdomain" value="subdomain">
                                        <label class="form-check-label d-block" for="type-subdomain">
                                            <strong>Subdomain Zone</strong>
                                            <small class="d-block text-muted">Domain + all subdomains</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check card p-3">
                                        <input class="form-check-input" type="radio" name="realm_type" 
                                               id="type-subdomain-only" value="subdomain_only">
                                        <label class="form-check-label d-block" for="type-subdomain-only">
                                            <strong>Subdomains Only</strong>
                                            <small class="d-block text-muted">Children only, not apex</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Record Types -->
                        <div class="mb-4">
                            <label class="form-label">Record Types</label>
                            <div class="row g-2">
                                {% for rt in ['A', 'AAAA', 'CNAME', 'TXT', 'MX', 'NS', 'SRV', 'CAA'] %}
                                <div class="col-auto">
                                    <div class="form-check">
                                        <input class="form-check-input record-type-check" type="checkbox" 
                                               name="record_types" value="{{ rt }}" id="rt-{{ rt }}">
                                        <label class="form-check-label" for="rt-{{ rt }}">{{ rt }}</label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Operations -->
                        <div class="mb-4">
                            <label class="form-label">Operations</label>
                            <div class="row g-3">
                                {% for op, desc in [('read', 'Read records'), ('create', 'Create new records'), ('update', 'Modify existing records'), ('delete', 'Delete records')] %}
                                <div class="col-auto">
                                    <div class="form-check">
                                        <input class="form-check-input operation-check" type="checkbox" 
                                               name="operations" value="{{ op }}" id="op-{{ op }}">
                                        <label class="form-check-label" for="op-{{ op }}">{{ desc }}</label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Submit -->
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{{ url_for('account.realms') }}" class="btn btn-outline-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send me-1"></i>Submit Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Info -->
            <div class="alert alert-info mt-4">
                <h6 class="alert-heading">
                    <i class="bi bi-info-circle me-1"></i>What happens next?
                </h6>
                <ul class="mb-0 small">
                    <li>Your request will be reviewed by an administrator</li>
                    <li>You'll receive an email notification when approved or rejected</li>
                    <li>Once approved, you can create tokens for this realm</li>
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Update domain suffix when zone is selected
document.getElementById('domain_root_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const rootDomain = selectedOption.dataset.rootDomain || 'example.com';
    document.getElementById('domain-suffix').textContent = '.' + rootDomain;
    updatePreview();
});

// Update preview when subdomain changes
document.getElementById('subdomain').addEventListener('input', updatePreview);

function updatePreview() {
    const subdomain = document.getElementById('subdomain').value.toLowerCase().replace(/[^a-z0-9\-]/g, '');
    const rootDomain = document.getElementById('domain-suffix').textContent.substring(1);
    const preview = document.getElementById('full-hostname-preview');
    
    if (subdomain) {
        preview.textContent = subdomain + '.' + rootDomain;
    } else {
        preview.textContent = rootDomain + ' (apex)';
    }
}

// Template button handling
document.querySelectorAll('.template-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        // Clear previous selections
        document.querySelectorAll('.record-type-check').forEach(cb => cb.checked = false);
        document.querySelectorAll('.operation-check').forEach(cb => cb.checked = false);
        
        // Apply template
        const realmType = this.dataset.realmType;
        const recordTypes = this.dataset.recordTypes.split(',');
        const operations = this.dataset.operations.split(',');
        
        // Set realm type
        document.getElementById('type-' + realmType).checked = true;
        
        // Set record types
        recordTypes.forEach(rt => {
            const cb = document.getElementById('rt-' + rt);
            if (cb) cb.checked = true;
        });
        
        // Set operations
        operations.forEach(op => {
            const cb = document.getElementById('op-' + op);
            if (cb) cb.checked = true;
        });
        
        // Visual feedback
        document.querySelectorAll('.template-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
    });
});

// Initialize preview
updatePreview();
</script>
{% endblock %}
