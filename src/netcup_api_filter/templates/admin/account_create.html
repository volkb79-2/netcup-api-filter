{# Admin Account Create - Create new account with invite link #}
{% extends "admin/base.html" %}

{% block title %}Create Account - Admin - Netcup API Filter{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-4">
    <h1 class="h3 mb-1">Create Account</h1>
    <p class="text-muted mb-0">Create a new user account and send an invitation link</p>
</div>

<form method="POST" action="{{ url_for('admin.account_create') }}" id="createAccountForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <!-- Centered Layout -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Account Details Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-person me-1"></i>Account Details
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="username">Username <span class="text-danger">*</span></label>
                            <input type="text" class="form-control font-monospace" id="username" name="username"
                                   required pattern="[a-z0-9_]{3,32}" 
                                   placeholder="e.g., johndoe"
                                   title="3-32 lowercase letters, numbers, or underscores">
                            <div class="form-text">Lowercase letters, numbers, and underscores. 3-32 characters.</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="email">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="email" name="email" required
                                   placeholder="user@example.com">
                        </div>
                    </div>
                    
                    <!-- Invite Link Settings -->
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-envelope-paper me-2"></i>
                        <strong>Invitation System:</strong> An invitation link will be sent to the user's email. 
                        They will set their own password when activating their account.
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="invite_expiry_hours">Invite Link Expires In</label>
                            <select class="form-select" id="invite_expiry_hours" name="invite_expiry_hours">
                                <option value="24">24 hours</option>
                                <option value="48" selected>48 hours</option>
                                <option value="72">72 hours (3 days)</option>
                                <option value="168">168 hours (7 days)</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Account Status</label>
                            <div class="form-check mt-2">
                                <input type="checkbox" class="form-check-input" id="skip_approval" name="skip_approval" checked>
                                <label class="form-check-label" for="skip_approval">
                                    Pre-approved (active immediately after accepting invite)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Security Notice -->
            <div class="alert alert-warning mb-4">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Security Note:</strong> Realm configuration is optional. If you configure a realm now,
                it will be pre-approved when the user accepts the invite. For maximum security (e.g., if email
                could be intercepted), leave the realm section empty and let the user request access after
                account activation.
            </div>
            
            <!-- Realm Configuration Card (Optional) -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-globe me-1"></i>Realm Configuration (Optional)</span>
                    <div class="form-check form-switch mb-0">
                        <input type="checkbox" class="form-check-input" id="include_realm" name="include_realm" 
                               role="switch" onchange="toggleRealmConfig()">
                        <label class="form-check-label" for="include_realm">Include pre-approved realm</label>
                    </div>
                </div>
                <div class="card-body" id="realmConfigBody" style="display: none;">
                    <p class="text-muted small mb-3">
                        Define which domain(s) the user can manage and what operations they can perform.
                        This realm will be pre-approved automatically.
                    </p>
                    
                    <!-- Template Selection -->
                    <div class="mb-4">
                        <label class="form-label">Quick Template</label>
                        <div class="row g-2">
                            <div class="col-md-4 col-lg-2">
                                <button type="button" class="btn btn-outline-secondary w-100 py-2" 
                                        onclick="applyTemplate('ddns_host')" title="Update single hostname IP">
                                    <i class="bi bi-house d-block mb-1"></i>
                                    <small>DDNS Host</small>
                                </button>
                            </div>
                            <div class="col-md-4 col-lg-2">
                                <button type="button" class="btn btn-outline-secondary w-100 py-2" 
                                        onclick="applyTemplate('ddns_subdomain')" title="Manage entire subdomain zone">
                                    <i class="bi bi-globe d-block mb-1"></i>
                                    <small>DDNS Zone</small>
                                </button>
                            </div>
                            <div class="col-md-4 col-lg-2">
                                <button type="button" class="btn btn-outline-secondary w-100 py-2" 
                                        onclick="applyTemplate('readonly')" title="View records without modification">
                                    <i class="bi bi-eye d-block mb-1"></i>
                                    <small>Read-Only</small>
                                </button>
                            </div>
                            <div class="col-md-4 col-lg-2">
                                <button type="button" class="btn btn-outline-secondary w-100 py-2" 
                                        onclick="applyTemplate('letsencrypt')" title="Automated certificate issuance">
                                    <i class="bi bi-shield-lock d-block mb-1"></i>
                                    <small>Let's Encrypt</small>
                                </button>
                            </div>
                            <div class="col-md-4 col-lg-2">
                                <button type="button" class="btn btn-outline-secondary w-100 py-2" 
                                        onclick="applyTemplate('full_control')" title="Complete DNS control">
                                    <i class="bi bi-gear d-block mb-1"></i>
                                    <small>Full Control</small>
                                </button>
                            </div>
                            <div class="col-md-4 col-lg-2">
                                <button type="button" class="btn btn-outline-secondary w-100 py-2" 
                                        onclick="applyTemplate('cname_only')" title="CDN/Load balancer aliases">
                                    <i class="bi bi-link-45deg d-block mb-1"></i>
                                    <small>CNAME Only</small>
                                </button>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Realm Configuration -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label" for="realm_type">Realm Type</label>
                            <select class="form-select" id="realm_type" name="realm_type">
                                <option value="">Select type...</option>
                                <option value="host">Host (exact match)</option>
                                <option value="subdomain">Subdomain (apex + children)</option>
                                <option value="subdomain_only">Subdomain Only (children only)</option>
                            </select>
                            <div class="form-text">How to match domain names.</div>
                        </div>
                        
                        <div class="col-md-8 mb-3">
                            <label class="form-label" for="realm_value">Realm Value</label>
                            <input type="text" class="form-control font-monospace" id="realm_value" name="realm_value"
                                   placeholder="e.g., home.example.com">
                            <div class="form-text">The domain or subdomain this account can manage.</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Record Types</label>
                            <div class="row g-2">
                                {% for rt in ['A', 'AAAA', 'CNAME', 'TXT', 'MX', 'NS', 'SRV', 'CAA'] %}
                                <div class="col-4 col-md-3">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input record-type" 
                                               id="rt_{{ rt }}" name="record_types" value="{{ rt }}">
                                        <label class="form-check-label" for="rt_{{ rt }}">{{ rt }}</label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Operations</label>
                            <div class="d-flex flex-wrap gap-3">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input operation" 
                                           id="op_read" name="operations" value="read">
                                    <label class="form-check-label" for="op_read">Read</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input operation" 
                                           id="op_update" name="operations" value="update">
                                    <label class="form-check-label" for="op_update">Update</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input operation" 
                                           id="op_create" name="operations" value="create">
                                    <label class="form-check-label" for="op_create">Create</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input operation" 
                                           id="op_delete" name="operations" value="delete">
                                    <label class="form-check-label" for="op_delete">Delete</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Section -->
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('admin.accounts_list') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Cancel
                </a>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <i class="bi bi-envelope-paper me-1"></i>Create Account & Send Invite
                </button>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_scripts %}
<script>
function toggleRealmConfig() {
    const includeRealm = document.getElementById('include_realm').checked;
    const realmBody = document.getElementById('realmConfigBody');
    realmBody.style.display = includeRealm ? 'block' : 'none';
    validateForm();
}

function applyTemplate(template) {
    // Enable realm if applying a template
    document.getElementById('include_realm').checked = true;
    toggleRealmConfig();
    
    // Clear all checkboxes first
    document.querySelectorAll('.record-type, .operation').forEach(cb => cb.checked = false);
    
    const templates = {
        ddns_host: {
            realm_type: 'host',
            record_types: ['A', 'AAAA'],
            operations: ['read', 'update']
        },
        ddns_subdomain: {
            realm_type: 'subdomain',
            record_types: ['A', 'AAAA'],
            operations: ['read', 'update', 'create', 'delete']
        },
        readonly: {
            realm_type: 'subdomain',
            record_types: ['A', 'AAAA', 'CNAME', 'TXT', 'MX', 'NS'],
            operations: ['read']
        },
        letsencrypt: {
            realm_type: 'subdomain',
            record_types: ['TXT'],
            operations: ['read', 'update', 'create', 'delete']
        },
        full_control: {
            realm_type: 'subdomain',
            record_types: ['A', 'AAAA', 'CNAME', 'TXT', 'MX', 'NS', 'SRV', 'CAA'],
            operations: ['read', 'update', 'create', 'delete']
        },
        cname_only: {
            realm_type: 'subdomain',
            record_types: ['CNAME'],
            operations: ['read', 'update', 'create', 'delete']
        }
    };
    
    const t = templates[template];
    if (!t) return;
    
    document.getElementById('realm_type').value = t.realm_type;
    t.record_types.forEach(rt => {
        const cb = document.getElementById('rt_' + rt);
        if (cb) cb.checked = true;
    });
    t.operations.forEach(op => {
        const cb = document.getElementById('op_' + op);
        if (cb) cb.checked = true;
    });
    
    // Validate after applying template
    validateForm();
}

function validateForm() {
    const username = document.getElementById('username').value.trim();
    const email = document.getElementById('email').value.trim();
    const includeRealm = document.getElementById('include_realm').checked;
    
    let isValid = username && email;
    
    // If realm is included, validate realm fields
    if (includeRealm) {
        const realmType = document.getElementById('realm_type').value;
        const realmValue = document.getElementById('realm_value').value.trim();
        const recordTypes = document.querySelectorAll('.record-type:checked').length > 0;
        const operations = document.querySelectorAll('.operation:checked').length > 0;
        isValid = isValid && realmType && realmValue && recordTypes && operations;
    }
    
    document.getElementById('submitBtn').disabled = !isValid;
}

// Add validation listeners
document.getElementById('username').addEventListener('input', validateForm);
document.getElementById('email').addEventListener('input', validateForm);
document.getElementById('realm_type').addEventListener('change', validateForm);
document.getElementById('realm_value').addEventListener('input', validateForm);
document.querySelectorAll('.record-type, .operation').forEach(cb => {
    cb.addEventListener('change', validateForm);
});

// Initial validation
document.addEventListener('DOMContentLoaded', validateForm);
</script>
{% endblock %}
