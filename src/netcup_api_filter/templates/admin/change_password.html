{# Admin Change Password - Admin password change form #}
{% extends "admin/base.html" %}

{% block title %}Change Password - Admin - Netcup API Filter{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-4">
    <h1 class="h3 mb-1">Change Password</h1>
    <p class="text-muted mb-0">Update your admin password</p>
</div>

<div class="row justify-content-center">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-body">
                <form method="POST" action="{{ url_for('admin.change_password') }}" id="changePasswordForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    {% if not force_change %}
                    <div class="mb-4">
                        <label class="form-label" for="current_password">Current Password <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="current_password" name="current_password" required>
                            <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('current_password')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-warning mb-4">
                        <strong>Password Change Required</strong>
                        <p class="mb-0 mt-1">You must change your password before continuing.</p>
                    </div>
                    {% endif %}
                    
                    <div class="mb-4">
                        <label class="form-label" for="new_password">New Password <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="password" class="form-control font-monospace" id="new_password" name="new_password" 
                                   required minlength="8" oninput="checkPasswordStrength()">
                            <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('new_password')">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="generatePassword()" title="Generate secure password">
                                <i class="bi bi-shuffle"></i> Generate
                            </button>
                        </div>
                        <div class="d-flex align-items-center mt-2 gap-2">
                            <div class="progress flex-grow-1" style="height: 4px;">
                                <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%"></div>
                            </div>
                            <span class="badge" id="entropyBadge" style="min-width: 70px;">0 bit</span>
                        </div>
                        <small class="text-muted" id="passwordHint">Minimum 100 bit entropy required</small>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label" for="confirm_password">Confirm New Password <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="password" class="form-control font-monospace" id="confirm_password" name="confirm_password" 
                                   required oninput="checkPasswordMatch()">
                            <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('confirm_password')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <small class="text-danger d-none" id="passwordMismatch">Passwords do not match</small>
                    </div>

                    <hr>

                    <!-- Password Requirements - Dynamic fulfilled list -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-2">
                            <small class="text-muted">Character classes fulfilled:</small>
                            <span class="badge bg-secondary ms-2" id="fulfilled-count">0/5</span>
                        </div>
                        <ul class="list-unstyled small mb-0" id="requirements-list">
                            <!-- Dynamically populated by JavaScript -->
                        </ul>
                        <small class="text-muted d-none" id="all-requirements-met">
                            <i class="bi bi-check-circle-fill text-success me-1"></i>All requirements met!
                        </small>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                            Change Password
                        </button>
                        {% if not force_change %}
                        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">Cancel</a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Charset for password generation (per UI_REQUIREMENTS.md 3.2)
const GENERATE_CHARSET = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-=_+;:,.|/?@#$%^&*';
const MIN_ENTROPY_BITS = 100;

function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    const btn = input.nextElementSibling;
    if (input.type === 'password') {
        input.type = 'text';
        btn.innerHTML = '<i class="bi bi-eye-slash"></i>';
    } else {
        input.type = 'password';
        btn.innerHTML = '<i class="bi bi-eye"></i>';
    }
}

function generatePassword() {
    // Generate password with ~128 bits of entropy
    // log2(79) ≈ 6.3 bits per char, so 21 chars ≈ 132 bits
    const length = 21;
    const array = new Uint32Array(length);
    crypto.getRandomValues(array);
    let password = '';
    for (let i = 0; i < length; i++) {
        password += GENERATE_CHARSET[array[i] % GENERATE_CHARSET.length];
    }
    
    const input = document.getElementById('new_password');
    input.value = password;
    input.type = 'text'; // Show generated password
    input.nextElementSibling.innerHTML = '<i class="bi bi-eye-slash"></i>';
    checkPasswordStrength();
}

function calculateEntropy(password) {
    if (!password) return 0;
    
    // Determine character pool size based on what's used
    let poolSize = 0;
    if (/[a-z]/.test(password)) poolSize += 26;
    if (/[A-Z]/.test(password)) poolSize += 26;
    if (/[0-9]/.test(password)) poolSize += 10;
    if (/[^a-zA-Z0-9]/.test(password)) poolSize += 32; // Common special chars
    
    if (poolSize === 0) return 0;
    
    // Entropy = length * log2(pool_size)
    const entropy = password.length * Math.log2(poolSize);
    return Math.floor(entropy);
}

const requirements = {
    length: { label: 'At least 8 characters', test: (p) => p.length >= 8 },
    upper: { label: 'Uppercase letter', test: (p) => /[A-Z]/.test(p) },
    lower: { label: 'Lowercase letter', test: (p) => /[a-z]/.test(p) },
    number: { label: 'Number', test: (p) => /[0-9]/.test(p) },
    special: { label: 'Special character (!@#$%^&*...)', test: (p) => /[!@#$%^&*(),.?":{}|<>\-=_+;:,.|/?@#$%^&*]/.test(p) }
};

function checkPasswordStrength() {
    const password = document.getElementById('new_password').value;
    const strengthBar = document.getElementById('passwordStrength');
    const hint = document.getElementById('passwordHint');
    const entropyBadge = document.getElementById('entropyBadge');
    const requirementsList = document.getElementById('requirements-list');
    const fulfilledCount = document.getElementById('fulfilled-count');
    const allMetMsg = document.getElementById('all-requirements-met');
    
    // Calculate entropy
    const entropy = calculateEntropy(password);
    entropyBadge.textContent = `${entropy} bit`;
    
    // Color-code entropy badge
    if (entropy < 50) {
        entropyBadge.className = 'badge bg-danger';
        hint.textContent = 'Very weak - too easy to crack';
        hint.className = 'text-danger small';
    } else if (entropy < 75) {
        entropyBadge.className = 'badge bg-warning text-dark';
        hint.textContent = 'Weak - increase length or complexity';
        hint.className = 'text-warning small';
    } else if (entropy < MIN_ENTROPY_BITS) {
        entropyBadge.className = 'badge bg-info text-dark';
        hint.textContent = `Need ${MIN_ENTROPY_BITS - entropy} more bits (min ${MIN_ENTROPY_BITS} required)`;
        hint.className = 'text-info small';
    } else if (entropy < 128) {
        entropyBadge.className = 'badge bg-success';
        hint.textContent = 'Good entropy - secure for most uses';
        hint.className = 'text-success small';
    } else {
        entropyBadge.className = 'badge bg-success';
        hint.textContent = 'Excellent entropy - very secure';
        hint.className = 'text-success small';
    }
    
    let fulfilled = [];
    let notFulfilled = [];
    
    // Check each requirement
    for (const [key, req] of Object.entries(requirements)) {
        if (req.test(password)) {
            fulfilled.push(req.label);
        } else {
            notFulfilled.push(req.label);
        }
    }
    
    // Update the requirements list - show only fulfilled items
    requirementsList.innerHTML = fulfilled.map(label => 
        `<li class="text-success"><i class="bi bi-check-circle-fill me-1"></i>${label}</li>`
    ).join('');
    
    // Update count badge
    const count = fulfilled.length;
    fulfilledCount.textContent = `${count}/5`;
    
    if (count === 0) {
        fulfilledCount.className = 'badge bg-secondary ms-2';
    } else if (count < 5) {
        fulfilledCount.className = 'badge bg-warning text-dark ms-2';
    } else {
        fulfilledCount.className = 'badge bg-success ms-2';
    }
    
    // Show "All requirements met" message
    if (count === 5) {
        allMetMsg.classList.remove('d-none');
    } else {
        allMetMsg.classList.add('d-none');
    }
    
    // Update strength bar based on entropy (scale: 0-150 bits = 0-100%)
    const strengthPercent = Math.min(100, (entropy / 150) * 100);
    strengthBar.style.width = strengthPercent + '%';
    
    if (entropy < 50) {
        strengthBar.className = 'progress-bar bg-danger';
    } else if (entropy < 75) {
        strengthBar.className = 'progress-bar bg-warning';
    } else if (entropy < MIN_ENTROPY_BITS) {
        strengthBar.className = 'progress-bar bg-info';
    } else {
        strengthBar.className = 'progress-bar bg-success';
    }
    
    updateSubmitButton();
}

function checkPasswordMatch() {
    const password = document.getElementById('new_password').value;
    const confirm = document.getElementById('confirm_password').value;
    const mismatch = document.getElementById('passwordMismatch');
    
    if (confirm && password !== confirm) {
        mismatch.classList.remove('d-none');
        return false;
    } else {
        mismatch.classList.add('d-none');
        return true;
    }
}

function updateSubmitButton() {
    const password = document.getElementById('new_password').value;
    const confirm = document.getElementById('confirm_password').value;
    const btn = document.getElementById('submitBtn');
    
    // Calculate entropy
    const entropy = calculateEntropy(password);
    
    // Check all requirements
    let allPassed = true;
    for (const [key, req] of Object.entries(requirements)) {
        if (!req.test(password)) {
            allPassed = false;
            break;
        }
    }
    
    // Must have minimum entropy, all requirements met, and passwords match
    allPassed = allPassed && entropy >= MIN_ENTROPY_BITS && password === confirm && confirm.length > 0;
    
    btn.disabled = !allPassed;
}

// Add event listeners
document.getElementById('new_password').addEventListener('input', checkPasswordStrength);
document.getElementById('confirm_password').addEventListener('input', function() {
    checkPasswordMatch();
    updateSubmitButton();
});
</script>
{% endblock %}
