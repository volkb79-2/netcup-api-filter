name: naf-dev

services:
  naf-dev-mailpit:
    image: axllent/mailpit:latest
    container_name: naf-dev-mailpit
    restart: unless-stopped
    ports:
      - "${MAILPIT_WEB_PORT:?MAILPIT_WEB_PORT must be set}:8025"
      - "${MAILPIT_SMTP_PORT:?MAILPIT_SMTP_PORT must be set}:1025"
    environment:
      # Basic auth for web UI and API
      MP_UI_AUTH: "${MAILPIT_USERNAME:?MAILPIT_USERNAME must be set}:${MAILPIT_PASSWORD:?MAILPIT_PASSWORD must be set}"
      
      # Accept any SMTP auth (for testing) - allow without TLS
      MP_SMTP_AUTH_ALLOW_INSECURE: "true"
      # Disable SMTP auth entirely for simple testing
      MP_SMTP_AUTH_ACCEPT_ANY: "true"
      
      # Max message size
      MP_MAX_MESSAGE_SIZE: "${MAILPIT_MAX_MESSAGE_SIZE:?MAILPIT_MAX_MESSAGE_SIZE must be set}"
      
      # UI features
      MP_UI_BIND_ADDR: "0.0.0.0:8025"
      MP_SMTP_BIND_ADDR: "0.0.0.0:1025"
      
      # Verbose logging for debugging
      MP_VERBOSE: "${MAILPIT_VERBOSE:-false}"
      
      # Webroot for reverse proxy (must match nginx location)
      MP_WEBROOT: "${MAILPIT_WEBROOT:-}"
    healthcheck:
      # Web UI returns 401 (Unauthorized) when auth is enabled, which means server is running
      # Exit code 0 if HTTP status is 200 or 401, exit code 1 otherwise
      test: ["CMD", "sh", "-c", "wget -q -O /dev/null -S http://localhost:8025/mailpit/ 2>&1 | grep -qE 'HTTP/1.1 (200|401)'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - naf-services

networks:
  naf-services:
    name: ${DOCKER_NETWORK_INTERNAL:?DOCKER_NETWORK_INTERNAL must be set}
    external: true
