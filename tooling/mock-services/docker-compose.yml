# Mock Services for Testing
# ==========================
# 
# Provides mock external services for E2E testing:
# - Mailpit: Modern MailHog alternative for SMTP testing
# - Mock GeoIP: MaxMind GeoIP API mock
# - Mock Netcup API: Netcup CCP API mock
#
# Usage:
#   source .env.workspace
#   docker compose --env-file ../.env.workspace -f docker-compose.yml up -d
#
# Access:
#   - Mailpit Web UI: http://localhost:8025
#   - Mailpit SMTP: localhost:1025
#   - Mailpit API: http://localhost:8025/api/v1/messages
#
# Note: These services join the devcontainer network so Flask can reach them

services:
  # ============================================================================
  # Mailpit - Modern SMTP testing server (replaces aiosmtpd)
  # ============================================================================
  # Docs: https://mailpit.axllent.org/
  # API:  https://mailpit.axllent.org/docs/api-v1/
  mailpit:
    image: axllent/mailpit:latest
    container_name: mailpit
    hostname: mailpit
    restart: unless-stopped
    ports:
      - "8025:8025"  # Web UI
      - "1025:1025"  # SMTP
    environment:
      # Accept any SMTP auth (for testing) - allow without TLS
      MP_SMTP_AUTH_ALLOW_INSECURE: "true"
      # Disable SMTP auth entirely for simple testing
      MP_SMTP_AUTH_ACCEPT_ANY: "true"
      # Max message size (10MB)
      MP_MAX_MESSAGE_SIZE: "10485760"
      # UI features
      MP_UI_BIND_ADDR: "0.0.0.0:8025"
      MP_SMTP_BIND_ADDR: "0.0.0.0:1025"
      # Verbose logging for debugging
      MP_VERBOSE: "false"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8025/api/v1/info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================================================
  # Mock GeoIP Server - MaxMind API mock
  # ============================================================================
  mock-geoip:
    image: python:3.11-slim
    container_name: mock-geoip
    hostname: mock-geoip
    restart: unless-stopped
    working_dir: /app
    command: >
      sh -c "pip install --no-cache-dir flask &&
             python -m flask run --host=0.0.0.0 --port=5556"
    ports:
      - "5556:5556"
    volumes:
      # Use PHYSICAL_REPO_ROOT for Docker mounts (Docker daemon runs on host, not in devcontainer)
      - ${PHYSICAL_REPO_ROOT:?PHYSICAL_REPO_ROOT must be set}/ui_tests:/app:ro
    environment:
      - FLASK_APP=mock_geoip_server:app
      - FLASK_RUN_PORT=5556
      - FLASK_RUN_HOST=0.0.0.0
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5556/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================================================
  # Mock Netcup API Server - CCP API mock
  # ============================================================================
  mock-netcup-api:
    image: python:3.11-slim
    container_name: mock-netcup-api
    hostname: mock-netcup-api
    restart: unless-stopped
    working_dir: /app
    command: >
      sh -c "pip install --no-cache-dir flask &&
             python -m flask run --host=0.0.0.0 --port=5555"
    ports:
      - "5555:5555"
    volumes:
      # Use PHYSICAL_REPO_ROOT for Docker mounts (Docker daemon runs on host, not in devcontainer)
      - ${PHYSICAL_REPO_ROOT:?PHYSICAL_REPO_ROOT must be set}/ui_tests:/app:ro
    environment:
      - FLASK_APP=mock_netcup_api:app
      - FLASK_RUN_PORT=5555
      - FLASK_RUN_HOST=0.0.0.0
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5555/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# Join the devcontainer network so services can communicate
networks:
  default:
    name: ${DOCKER_NETWORK_INTERNAL:?DOCKER_NETWORK_INTERNAL must be set}
    external: true
