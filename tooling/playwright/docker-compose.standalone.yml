# Standalone Playwright Service Container
# ========================================
# 
# This docker-compose file provides a standalone Playwright browser automation service
# that can be used by multiple clients including:
# - VS Code MCP clients (port 8765)
# - WebSocket clients / pytest tests (port 3000)
#
# Features:
# - Multi-client WebSocket service
# - Optional TLS with self-signed certificates
# - Session management per client
# - Token-based authentication (optional)
# - Full Playwright API access (no MCP limitations)
#
# Usage:
#   # Basic (no TLS, no auth)
#   docker compose -f docker-compose.standalone.yml up -d
#
#   # With TLS (self-signed certs auto-generated)
#   SSL_ENABLED=true docker compose -f docker-compose.standalone.yml up -d
#
#   # With authentication
#   WS_AUTH_TOKEN=my-secret-token docker compose -f docker-compose.standalone.yml up -d
#
#   # Full production-like setup
#   SSL_ENABLED=true WS_AUTH_TOKEN=$(openssl rand -hex 32) docker compose -f docker-compose.standalone.yml up -d

services:
  # Certificate generator - creates self-signed certs on startup
  cert-generator:
    image: alpine:latest
    container_name: playwright-cert-gen
    volumes:
      - playwright-certs:/certs
    entrypoint: /bin/sh
    command:
      - -c
      - |
        if [ "$$SSL_ENABLED" != "true" ]; then
          echo "SSL disabled, skipping certificate generation"
          exit 0
        fi
        
        if [ -f /certs/server.crt ] && [ -f /certs/server.key ]; then
          echo "Certificates already exist, skipping generation"
          exit 0
        fi
        
        echo "Installing OpenSSL..."
        apk add --no-cache openssl
        
        echo "Generating self-signed certificate..."
        openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
          -keyout /certs/server.key \
          -out /certs/server.crt \
          -subj "/C=US/ST=Local/L=Development/O=Playwright/CN=localhost" \
          -addext "subjectAltName=DNS:localhost,DNS:playwright,IP:127.0.0.1"
        
        chmod 644 /certs/server.crt
        chmod 600 /certs/server.key
        echo "Certificate generation complete"
    environment:
      - SSL_ENABLED=${SSL_ENABLED:-false}

  # Screenshots directory initialization
  playwright-init:
    image: alpine:latest
    container_name: playwright-standalone-init
    user: "root:root"
    command: >
      sh -c "
      mkdir -p /screenshots /workspace &&
      chmod 777 /screenshots /workspace &&
      echo 'Directories initialized'
      "
    volumes:
      - playwright-screenshots:/screenshots
      - playwright-workspace:/workspace

  # Main Playwright service
  playwright-standalone:
    build:
      context: .
      dockerfile: Dockerfile.standalone
    container_name: playwright-standalone
    hostname: playwright
    depends_on:
      cert-generator:
        condition: service_completed_successfully
      playwright-init:
        condition: service_completed_successfully
    
    environment:
      # WebSocket server settings
      WS_PORT: "${WS_PORT:-3000}"
      WS_HOST: "0.0.0.0"
      WS_AUTH_TOKEN: "${WS_AUTH_TOKEN:-}"
      WS_MAX_SESSIONS: "${WS_MAX_SESSIONS:-10}"
      WS_SESSION_TIMEOUT: "${WS_SESSION_TIMEOUT:-3600}"
      
      # MCP server settings
      MCP_ENABLED: "${MCP_ENABLED:-true}"
      MCP_PORT: "${MCP_PORT:-8765}"
      MCP_SERVER_NAME: "${MCP_SERVER_NAME:-playwright}"
      
      # Playwright settings
      PLAYWRIGHT_HEADLESS: "${PLAYWRIGHT_HEADLESS:-true}"
      PLAYWRIGHT_BROWSER: "${PLAYWRIGHT_BROWSER:-chromium}"
      
      # TLS settings
      SSL_ENABLED: "${SSL_ENABLED:-false}"
      SSL_CERT_PATH: "/certs/server.crt"
      SSL_KEY_PATH: "/certs/server.key"
    
    ports:
      # WebSocket server (primary interface for tests)
      - "${WS_EXTERNAL_PORT:-3000}:${WS_PORT:-3000}"
      # MCP server (for AI agents / VS Code)
      - "${MCP_EXTERNAL_PORT:-8765}:${MCP_PORT:-8765}"
    
    volumes:
      # Certificates (read-only)
      - playwright-certs:/certs:ro
      # Screenshots output (read-write)
      - playwright-screenshots:/screenshots:rw
      # Workspace for test files (can be overridden)
      - playwright-workspace:/workspace:rw
    
    # Shared memory for browser
    shm_size: "2gb"
    
    # Health check
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.connect(('localhost', 3000)); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    restart: unless-stopped

volumes:
  playwright-certs:
    driver: local
  playwright-screenshots:
    driver: local
  playwright-workspace:
    driver: local

# Optional: Use external network for integration with other services
# networks:
#   default:
#     name: ${DOCKER_NETWORK:-playwright-network}
#     external: ${DOCKER_NETWORK_EXTERNAL:-false}
