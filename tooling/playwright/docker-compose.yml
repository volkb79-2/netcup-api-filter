# Standalone Playwright Service Container
# ========================================
# 
# This docker-compose file provides a standalone Playwright browser automation service
# that can be used by multiple clients including:
# - VS Code MCP clients (port 8765)
# - WebSocket clients / pytest tests (port 3000)
#
# Features:
# - Multi-client WebSocket service
# - Optional TLS with self-signed certificates
# - Session management per client
# - Token-based authentication (optional)
# - Full Playwright API access (no MCP limitations)
#
# Usage:
#   # Basic (no TLS, no auth)
#   docker compose -f docker-compose.standalone.yml up -d
#
#   # With TLS (self-signed certs auto-generated)
#   SSL_ENABLED=true docker compose -f docker-compose.standalone.yml up -d
#
#   # With authentication
#   WS_AUTH_TOKEN=my-secret-token docker compose -f docker-compose.standalone.yml up -d
#
#   # Full production-like setup
#   SSL_ENABLED=true WS_AUTH_TOKEN=$(openssl rand -hex 32) docker compose -f docker-compose.standalone.yml up -d

services:
  # Certificate generator - creates self-signed certs on startup
  cert-generator:
    image: alpine:latest
    container_name: naf-playwright-cert-gen
    volumes:
      - playwright-certs:/certs
    entrypoint: /bin/sh
    command:
      - -c
      - |
        if [ "$$SSL_ENABLED" != "true" ]; then
          echo "SSL disabled, skipping certificate generation"
          exit 0
        fi
        
        if [ -f /certs/server.crt ] && [ -f /certs/server.key ]; then
          echo "Certificates already exist, skipping generation"
          exit 0
        fi
        
        echo "Installing OpenSSL..."
        apk add --no-cache openssl
        
        echo "Generating self-signed certificate..."
        openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
          -keyout /certs/server.key \
          -out /certs/server.crt \
          -subj "/C=US/ST=Local/L=Development/O=Playwright/CN=localhost" \
          -addext "subjectAltName=DNS:localhost,DNS:playwright,IP:127.0.0.1"
        
        chmod 644 /certs/server.crt
        chmod 600 /certs/server.key
        echo "Certificate generation complete"
    environment:
      - SSL_ENABLED=${SSL_ENABLED:-false}

  # Screenshots directory initialization
  # playwright-init:
  #   image: alpine:latest
  #   container_name: playwright-init
  #   user: "root:root"
  #   command: >
  #     sh -c "
  #     mkdir -p /workspaces/netcup-api-filter/deploy-local/screenshots &&
  #     chmod 777 /workspaces/netcup-api-filter/deploy-local/screenshots &&
  #     echo 'Screenshot directory initialized'
  #     "
  #   volumes:
  #     - playwright-screenshots:/screenshots
  #     - playwright-workspace:/workspace

  # Main Playwright service
  playwright:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: naf-playwright
    hostname: naf-playwright
    # Run as same user as devcontainer (vscode) to avoid permission issues
    # The uid/gid are passed from .env.workspace or default to 1000
    user: "${DOCKER_UID:-1000}:${DOCKER_GID:-1000}"
    depends_on:
      cert-generator:
        condition: service_completed_successfully
    
    environment:
      # WebSocket server settings
      WS_PORT: "${WS_PORT}"
      WS_HOST: "0.0.0.0"
      WS_AUTH_TOKEN: "${WS_AUTH_TOKEN}"
      WS_MAX_SESSIONS: "${WS_MAX_SESSIONS}"
      WS_SESSION_TIMEOUT: "${WS_SESSION_TIMEOUT}"
      
      # MCP server settings
      MCP_ENABLED: "${MCP_ENABLED}"
      MCP_PORT: "${MCP_PORT}"
      MCP_SERVER_NAME: "${MCP_SERVER_NAME}"
      
      # Playwright settings
      PLAYWRIGHT_HEADLESS: "${PLAYWRIGHT_HEADLESS}"
      PLAYWRIGHT_BROWSER: "${PLAYWRIGHT_BROWSER}"
      
      # TLS settings
      SSL_ENABLED: "${SSL_ENABLED}"
      SSL_CERT_PATH: "/certs/server.crt"
      SSL_KEY_PATH: "/certs/server.key"
    
    ports:
      # WebSocket server (primary interface for tests)
      - "${WS_EXTERNAL_PORT}:${WS_PORT}"
      # MCP server (for AI agents / VS Code)
      - "${MCP_EXTERNAL_PORT}:${MCP_PORT}"
    
    volumes:
      # Certificates (read-only)
      - playwright-certs:/certs:ro
      # Mount physical repo to match devcontainer path exactly
      # allow playwright to use the same workspace paths as in devcontainer, e.g. we map
      # `/home/vb/volkb79-2/netcup-api-filter` --> `/workspaces/netcup-api-filter`
      - ${PHYSICAL_REPO_ROOT:?PHYSICAL_REPO_ROOT must be set}:${REPO_ROOT:?REPO_ROOT must be set}:rw
    
    # Shared memory for browser
    shm_size: "2gb"
    
    # Health check
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.connect(('localhost', 3000)); s.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    restart: unless-stopped

volumes:
  playwright-certs:
    driver: local

# Use devcontainer network for integration
networks:
  default:
    name: ${DOCKER_NETWORK_INTERNAL:?DOCKER_NETWORK_INTERNAL must be set (source .env.workspace)}
    external: true
