#!/usr/bin/env python3
"""
MCP Server for Playwright Browser Automation

Provides Model Context Protocol (MCP) interface to Playwright for AI agent exploration.
Uses official MCP SDK for proper protocol implementation.

Note: This is for exploration only. Use direct Playwright API for production testing.
"""

import os
import asyncio
import logging
from typing import Optional

from mcp.server import FastMCP
from playwright.async_api import async_playwright, Browser, Page

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# Configuration from environment
MCP_PORT = int(os.getenv('MCP_PORT', '8765'))
MCP_SERVER_NAME = os.getenv('MCP_SERVER_NAME', 'playwright')
PLAYWRIGHT_HEADLESS = os.getenv('PLAYWRIGHT_HEADLESS', 'true').lower() == 'true'
PLAYWRIGHT_BROWSER = os.getenv('PLAYWRIGHT_BROWSER', 'chromium')

# Initialize MCP server using official SDK
mcp = FastMCP(MCP_SERVER_NAME)

# Global browser state
_browser: Optional[Browser] = None
_page: Optional[Page] = None
_playwright = None


async def ensure_browser():
    """Ensure browser is initialized"""
    global _browser, _page, _playwright
    
    if _browser is None or not _browser.is_connected():
        logger.info(f"Initializing {PLAYWRIGHT_BROWSER} browser (headless={PLAYWRIGHT_HEADLESS})")
        _playwright = await async_playwright().start()
        
        if PLAYWRIGHT_BROWSER == 'chromium':
            _browser = await _playwright.chromium.launch(headless=PLAYWRIGHT_HEADLESS)
        elif PLAYWRIGHT_BROWSER == 'firefox':
            _browser = await _playwright.firefox.launch(headless=PLAYWRIGHT_HEADLESS)
        elif PLAYWRIGHT_BROWSER == 'webkit':
            _browser = await _playwright.webkit.launch(headless=PLAYWRIGHT_HEADLESS)
        else:
            raise ValueError(f"Unsupported browser: {PLAYWRIGHT_BROWSER}")
        
        _page = await _browser.new_page()
        logger.info("Browser initialized successfully")
    
    return _browser, _page


@app.get("/")
async def root():
    """Root endpoint - health check"""
    return {
        "service": "MCP Playwright Server",
        "name": MCP_SERVER_NAME,
        "status": "running",
        "browser": PLAYWRIGHT_BROWSER,
        "headless": PLAYWRIGHT_HEADLESS,
        "mcp_endpoint": "/mcp"
    }


@app.get("/mcp")
async def mcp_info():
    """MCP protocol information endpoint"""
    return {
        "protocol": "MCP",
        "version": "1.0",
        "server": MCP_SERVER_NAME,
        "capabilities": [
            "navigate",
            "screenshot",
            "get_content",
            "click",
            "fill",
            "evaluate"
        ],
        "endpoints": {
            "navigate": "/mcp/navigate",
            "screenshot": "/mcp/screenshot",
            "content": "/mcp/content",
            "click": "/mcp/click",
            "fill": "/mcp/fill",
            "evaluate": "/mcp/evaluate"
        }
    }


@app.post("/mcp/navigate")
async def navigate(url: str):
    """Navigate to URL"""
    try:
        _, page = await ensure_browser()
        await page.goto(url, wait_until="networkidle")
        
        return {
            "success": True,
            "url": page.url,
            "title": await page.title()
        }
    except Exception as e:
        logger.error(f"Navigation error: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@app.post("/mcp/screenshot")
async def screenshot(path: Optional[str] = None):
    """Take screenshot of current page"""
    try:
        _, page = await ensure_browser()
        
        if path is None:
            path = f"/screenshots/mcp-{asyncio.get_event_loop().time()}.png"
        
        # Ensure path is within screenshots directory
        screenshot_path = Path(path)
        if not screenshot_path.is_absolute():
            screenshot_path = Path("/screenshots") / screenshot_path.name
        
        await page.screenshot(path=str(screenshot_path), full_page=True)
        
        return {
            "success": True,
            "path": str(screenshot_path),
            "url": page.url
        }
    except Exception as e:
        logger.error(f"Screenshot error: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@app.get("/mcp/content")
async def get_content():
    """Get page HTML content"""
    try:
        _, page = await ensure_browser()
        
        content = await page.content()
        
        return {
            "success": True,
            "url": page.url,
            "content": content,
            "title": await page.title()
        }
    except Exception as e:
        logger.error(f"Content retrieval error: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@app.post("/mcp/click")
async def click(selector: str):
    """Click element by selector"""
    try:
        _, page = await ensure_browser()
        
        await page.click(selector)
        
        return {
            "success": True,
            "selector": selector,
            "url": page.url
        }
    except Exception as e:
        logger.error(f"Click error: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@app.post("/mcp/fill")
async def fill(selector: str, value: str):
    """Fill input field by selector"""
    try:
        _, page = await ensure_browser()
        
        await page.fill(selector, value)
        
        return {
            "success": True,
            "selector": selector,
            "value": value,
            "url": page.url
        }
    except Exception as e:
        logger.error(f"Fill error: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@app.post("/mcp/evaluate")
async def evaluate(expression: str):
    """Evaluate JavaScript expression"""
    try:
        _, page = await ensure_browser()
        
        result = await page.evaluate(expression)
        
        return {
            "success": True,
            "expression": expression,
            "result": result,
            "url": page.url
        }
    except Exception as e:
        logger.error(f"Evaluation error: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@app.on_event("startup")
async def startup_event():
    """Initialize on startup"""
    logger.info(f"MCP Playwright Server starting on port {MCP_PORT}")
    logger.info(f"Server name: {MCP_SERVER_NAME}")
    logger.info(f"Browser: {PLAYWRIGHT_BROWSER} (headless={PLAYWRIGHT_HEADLESS})")


@app.on_event("shutdown")
async def shutdown_event():
    """Cleanup on shutdown"""
    global _browser, _playwright
    
    if _browser:
        logger.info("Closing browser...")
        await _browser.close()
    
    if _playwright:
        logger.info("Stopping Playwright...")
        await _playwright.stop()
    
    logger.info("MCP Playwright Server stopped")


if __name__ == "__main__":
    # Check if MCP is enabled
    if os.getenv('MCP_ENABLED', 'false').lower() != 'true':
        logger.warning("MCP_ENABLED is not set to 'true'. Server will not start.")
        logger.info("Set MCP_ENABLED=true in environment to enable MCP server")
        exit(0)
    
    logger.info(f"Starting MCP server on 0.0.0.0:{MCP_PORT}")
    
    uvicorn.run(
        app,
        host="0.0.0.0",
        port=MCP_PORT,
        log_level="info"
    )
