# HTTPS server - TLS termination with Let's Encrypt certificates
# Template variables (substituted by render-nginx-conf.sh using envsubst):
#   gstammtisch.dchive.de - Public FQDN (e.g., gstammtisch.dchive.de)
#   netcup-api-filter-devcontainer-vb   - Backend hostname (e.g., netcup-api-filter-devcontainer)
#   5100   - Backend port (e.g., 5100)

server {
    listen 443 ssl;
    # Server name matches the public FQDN (from proxy.env)
    server_name gstammtisch.dchive.de _;

    # Certificate paths constructed from LOCAL_TLS_DOMAIN
    # Let's Encrypt structure: /etc/letsencrypt/live/<domain>/fullchain.pem
    ssl_certificate     /etc/letsencrypt/live/gstammtisch.dchive.de/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/gstammtisch.dchive.de/privkey.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    
    # CRITICAL: disable_symlinks off allows nginx to follow Let's Encrypt symlinks
    # Let's Encrypt structure: live/<domain>/*.pem -> ../../archive/<domain>/*.pem
    disable_symlinks off;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;
    add_header Referrer-Policy "strict-origin-when-cross-origin";

    # Mailpit web UI and API
    # Mailpit handles webroot internally via MP_WEBROOT environment variable
    location /mailpit/ {
        # Proxy to Mailpit WITHOUT stripping prefix (Mailpit expects /mailpit/)
        proxy_pass http://naf-mailpit:8025;
        proxy_http_version 1.1;
        
        # WebSocket support (for real-time UI updates)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Pass through basic auth credentials
        proxy_set_header Authorization $http_authorization;
        proxy_pass_header Authorization;
        
        # Disable buffering for SSE/WebSocket
        proxy_buffering off;
    }

    location / {
        # Forward all requests to Flask backend (HTTP, not HTTPS)
        # nginx terminates TLS, backend receives plain HTTP
        proxy_pass http://netcup-api-filter-devcontainer-vb:5100;
        proxy_http_version 1.1;
        
        # Preserve original Host header
        proxy_set_header Host $host;
        
        # Forward client IP (for rate limiting, logging)
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # CRITICAL: Tell Flask the request came via HTTPS
        # Flask uses this to set Secure flag on session cookies
        proxy_set_header X-Forwarded-Proto https;
        
        # Preserve original hostname and port
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port 443;
        
        # Disable automatic redirect rewriting
        proxy_redirect off;
    }
}

# HTTP server - redirect all traffic to HTTPS
server {
    listen 80;
    server_name gstammtisch.dchive.de _;
    # 301 Moved Permanently - browsers will cache this redirect
    return 301 https://$host$request_uri;
}
